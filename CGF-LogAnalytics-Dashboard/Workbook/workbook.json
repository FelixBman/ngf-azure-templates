{
	"contentVersion": "1.0.0.0",
	"parameters": {
		"workbookSourceId": {
			"type": "string",
			"metadata": {
				"description": "The id of resource instance to which the workbook will be associated"
			}
		},
		"workbookId": {
			"type": "string",
			"defaultValue": "[newGuid()]",
			"metadata": {
				"description": "The unique guid for this workbook instance"
			}
		},
		"workbookType": {
			"type": "string",
			"defaultValue": "sentinel",
			"metadata": {
				"description": "The unique guid for this workbook instance"
			}
		}
	},
	"variables": {
		"singleQuote": "'"
	},
	"resources": [
		 {
      "name": "[parameters('workbookId')]",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "apiVersion": "2018-06-17-preview",
      "dependsOn": [],
      "kind": "shared",
      "properties": {
        "displayName": "Barracuda CloudGen Firewall Dashboard",
        "serializedData": "[concat('{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# Barracuda CloudGen Firewall dashboard\\r\\n\\r\\nThis workbook can be used to provide common status and performance information about your Barracuda Firewalls. \\r\\n\\r\\nAny Barracuda Firewall that can report data into OMS can be reported on this page. \\r\\nUse the dropdowns to move the reports between Subscriptions, Workspaces or Firewalls.\",\"style\":\"info\"},\"name\":\"text - 7\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"997c84bc-c454-47f7-a288-99429173dfeb\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Subscription\",\"type\":6,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"',variables('singleQuote'), '\",\"delimiter\":\",\",\"value\":[\"/subscriptions/', subscription().subscriptionId , '\"],\"typeSettings\":{\"additionalResourceOptions\":[],\"includeAll\":false}},{\"id\":\"73638b3d-aa3f-4872-a56b-a0eaf3fc7714\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Workspace\",\"type\":5,\"isRequired\":true,\"query\":\"Resources | where type =~ \\\"microsoft.operationalinsights/workspaces\\\" | order by name | project id, name, selected=row_number()==1, group=resourceGroup\",\"crossComponentResources\":[\"{Subscription}\"],\"typeSettings\":{\"additionalResourceOptions\":[]},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"96730b84-3f96-4838-ac95-6999dc7d6438\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Firewall\",\"type\":2,\"description\":\"Used to report on specific firewalls\",\"isRequired\":true,\"multiSelect\":true,\"quote\":\"',variables('singleQuote'), '\",\"delimiter\":\",\",\"query\":\"Perf | where TimeGenerated > now() - 30d and TimeGenerated < now() and InstanceName == \\\"BNGF\\\" | distinct Computer | project value = Computer\",\"value\":[\"value::all\"],\"typeSettings\":{\"resourceTypeFilter\":{\"microsoft.compute/virtualmachines\":true},\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 0\"},{\"type\":1,\"content\":{\"json\":\"If you find missing data below, it may be that you haven',variables('singleQuote'), 't enabled all the required reporting. \\r\\n-First please confirm you have followed the steps ![here](https://github.com/barracudanetworks/ngf-azure-templates/blob/master/CGF-LogAnalytics-Dashboard/README.md) to enable additional syslog data out\\r\\n-Also please review the troubleshooting steps on the same page.\\r\\n-If all this fails please contact Barracuda support\",\"style\":\"warning\"},\"name\":\"text - 8\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"VPN Status\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Perf | where ObjectName == \\\"Site_to_site_VPN_Tunnels_Up\\\" | where Computer in ({Firewall}) | project-rename Status = ObjectName | project-rename Firewall = Computer | summarize AggregatedValue = avg(CounterValue) by Firewall, Status | project-rename Qty = AggregatedValue\",\"size\":1,\"title\":\"Up VPN Tunnels by Firewall\",\"noDataMessage\":\"0\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"graph\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"TableName\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"showBorder\":false,\"rowLimit\":1},\"graphSettings\":{\"type\":2,\"topContent\":{\"columnMatch\":\"Firewall\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"Qty\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":0,\"maximumSignificantDigits\":3}}},\"hivesContent\":{\"columnMatch\":\"Status\",\"formatter\":1},\"nodeIdField\":\"Firewall\",\"graphOrientation\":3,\"showOrientationToggles\":false,\"nodeSize\":null,\"staticNodeSize\":100,\"colorSettings\":{\"nodeColorField\":\"Qty\",\"type\":3,\"thresholdsGrid\":[{\"operator\":\">\",\"thresholdValue\":\"1\",\"representation\":\"green\"},{\"operator\":\">\",\"thresholdValue\":\"10\",\"representation\":\"green\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"gray\"}]},\"groupByField\":\"Status\",\"hivesMargin\":5},\"mapSettings\":{\"locInfo\":\"LatLong\",\"sizeSettings\":\"Qty\",\"sizeAggregation\":\"Sum\",\"legendMetric\":\"Qty\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"type\":\"heatmap\",\"colorAggregation\":\"Sum\",\"nodeColorField\":\"Qty\",\"heatmapPalette\":\"greenRed\"}}},\"customWidth\":\"50\",\"showPin\":true,\"name\":\"Up VPN Tunnels by Firewall\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Perf | where ObjectName == \\\"Site_to_site_VPN_Tunnels_Down\\\" | where Computer in ({Firewall})  | project-rename Status = ObjectName | project-rename Firewall = Computer | summarize AggregatedValue = avg(CounterValue) by Firewall, Status | project-rename Qty = AggregatedValue\",\"size\":1,\"title\":\"Down VPN Tunnels by Firewall\",\"noDataMessage\":\"0\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"graph\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"TableName\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"showBorder\":false,\"rowLimit\":1},\"graphSettings\":{\"type\":2,\"topContent\":{\"columnMatch\":\"Firewall\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"Qty\",\"formatter\":12,\"formatOptions\":{\"palette\":\"none\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":0,\"maximumSignificantDigits\":3}}},\"hivesContent\":{\"columnMatch\":\"Status\",\"formatter\":1},\"nodeIdField\":\"Firewall\",\"graphOrientation\":3,\"showOrientationToggles\":false,\"nodeSize\":null,\"staticNodeSize\":100,\"colorSettings\":{\"nodeColorField\":\"Qty\",\"type\":3,\"thresholdsGrid\":[{\"operator\":\">\",\"thresholdValue\":\"1\",\"representation\":\"orange\"},{\"operator\":\">\",\"thresholdValue\":\"5\",\"representation\":\"redBright\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"yellow\"}]},\"groupByField\":\"Status\",\"hivesMargin\":5},\"mapSettings\":{\"locInfo\":\"LatLong\",\"sizeSettings\":\"Qty\",\"sizeAggregation\":\"Sum\",\"legendMetric\":\"Qty\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"type\":\"heatmap\",\"colorAggregation\":\"Sum\",\"nodeColorField\":\"Qty\",\"heatmapPalette\":\"greenRed\"}}},\"customWidth\":\"50\",\"showPin\":true,\"name\":\"Down VPN Tunnels by Firewall\"}]},\"customWidth\":\"50\",\"name\":\"VPN Status Group\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Firewall Traffic Overview\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"search * | where Type == \\\"CommonSecurityLog\\\" | where Computer in ({Firewall})  | summarize count() by Computer\",\"size\":0,\"title\":\"Traffic per Firewall\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"chartSettings\":{\"yAxis\":[\"count_\"],\"group\":\"Computer\",\"createOtherGroup\":null,\"ySettings\":{\"numberFormatSettings\":{\"unit\":0,\"options\":{\"style\":\"decimal\",\"useGrouping\":true}}}}},\"name\":\"Traffic per Firewall\"}]},\"customWidth\":\"25\",\"name\":\"Firewall Traffic Overview\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Perf | where Computer in ({Firewall})  | where (ObjectName == \\\"Load\\\") | summarize max(CounterValue) by Computer\",\"size\":0,\"aggregation\":2,\"title\":\"Current Load\",\"timeContext\":{\"durationMs\":1800000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Computer\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"max_CounterValue\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"}},\"showBorder\":false,\"sortCriteriaField\":\"Computer\"},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"Computer\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"sum_CounterValue\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"customWidth\":\"25\",\"name\":\"Current Firewall Load\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Firewall Traffic Details\",\"expandable\":true,\"expanded\":true,\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let TotalRecords = toscalar(search * | where Type == \\\"CommonSecurityLog\\\" | where Computer in~ ({Firewall}) | where DeviceAction==\\\"Allow\\\" | count); search * | where Type == \\\"CommonSecurityLog\\\" | where Computer in~ ({Firewall}) | summarize Blocks=countif(DeviceAction == \\\"Allow\\\") ,count_=count(), percent=round(countif(DeviceAction == \\\"Allow\\\")*1.0/TotalRecords*100.0,2) by SourceIP | sort by percent desc | limit 10 | project SourceIP, percent\",\"size\":0,\"title\":\"Allowed by Firewall\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"percent\",\"formatter\":8,\"formatOptions\":{\"palette\":\"turquoise\"}}]},\"tileSettings\":{\"showBorder\":false}},\"customWidth\":\"50\",\"name\":\"Allowed by Firewall\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let TotalRecords = toscalar(search * | where Type == \\\"CommonSecurityLog\\\" | where Computer in~ ({Firewall}) | where DeviceAction==\\\"Block\\\" | count); search * | where Type == \\\"CommonSecurityLog\\\" | where Computer in~ ({Firewall}) | summarize Blocks=countif(DeviceAction == \\\"Block\\\") ,count_=count(), percent=round(countif(DeviceAction == \\\"Block\\\")*1.0/TotalRecords*100.0,2) by SourceIP | sort by percent desc | limit 10 | project SourceIP, percent \",\"size\":0,\"title\":\"Blocked by Firewall\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"percent\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\"}}],\"filter\":true},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"SourceIP\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"percent\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"nodeIdField\":\"SourceIP\",\"sourceIdField\":\"percent\",\"targetIdField\":\"SourceIP\",\"graphOrientation\":3,\"showOrientationToggles\":false,\"nodeSize\":null,\"staticNodeSize\":100,\"colorSettings\":{\"nodeColorField\":\"percent\",\"type\":3,\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"blue\"},{\"operator\":\">\",\"thresholdValue\":\"50\",\"representation\":\"orange\"},{\"operator\":\">\",\"thresholdValue\":\"70\",\"representation\":\"redBright\"}]},\"hivesMargin\":5}},\"customWidth\":\"50\",\"name\":\"Blocked by Firewall\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CGFWFirewallActivity \\n| extend Rule = coalesce(FirewallRule, \\\"None\\\")\\n| summarize count() by Rule\\n| take 10\",\"size\":3,\"title\":\"Rule Summary\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"None\",\"color\":\"green\"}]}},\"customWidth\":\"33\",\"name\":\"RuleSummary\",\"styleSettings\":{\"margin\":\"10\",\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CGFWFirewallActivity \\n| extend rule = coalesce(Info, \\\"None\\\")\\n| summarize count() by rule\\n| take 10\\n\",\"size\":3,\"title\":\"Drop Summary\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"DropSummary\",\"styleSettings\":{\"margin\":\"10\",\"showBorder\":true}},{\"type\":1,\"content\":{\"json\":\"---\"},\"name\":\"---\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"union Perf | where Computer in~ ({Firewall})| where ObjectName == \\\"Connections_New\\\"\",\"size\":0,\"title\":\"New Connections\",\"timeContext\":{\"durationMs\":1800000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"CounterValue\",\"label\":\"Connections\"}]}},\"customWidth\":\"45\",\"name\":\"NewConnections\",\"styleSettings\":{\"margin\":\"10\",\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CGFWFirewallActivity \\n| where Computer in~ ({Firewall})\\n| where isnotempty(Application)\\n| summarize count() by Application\\n| take 10\",\"size\":0,\"title\":\"Top 10 Applications\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"Application\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"customWidth\":\"50\",\"name\":\"TopApplications\",\"styleSettings\":{\"margin\":\"10\",\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CGFWFirewallActivity\\n| where Computer in~ ({Firewall})\\n| extend User = coalesce(User, \\\"Unauthenticated\\\") \\n| summarize count() by User\\n| take 10\",\"size\":3,\"title\":\"Top 10 Users\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"TopUsers\",\"styleSettings\":{\"margin\":\"10\",\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CGFWFirewallActivity\\n| where Computer in~ ({Firewall})\\n| extend Protocol = coalesce(L4Protocol, \\\"Other\\\") \\n| summarize count() by L4Protocol\",\"size\":3,\"title\":\"Layer 4 Protocol Summary\",\"noDataMessage\":\"No suitable data found for this firewall\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"L4Summary\",\"styleSettings\":{\"margin\":\"10\",\"showBorder\":true}}]},\"name\":\"Firewall Traffic Details\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[]},\"name\":\"Allowed Traffic Details\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Firewall Performance Details\",\"expandable\":true,\"expanded\":true,\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Perf | where Computer in~ ({Firewall}) | where ( ObjectName == \\\"Processor\\\" ) | where ( CounterName == \\\"% Processor Time\\\" ) | where ( CounterPath has \\\"Total\\\" ) | summarize avg(CounterValue) by Computer\",\"size\":1,\"title\":\"Average CPU\",\"noDataMessage\":\"No data found\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"linechart\"},\"customWidth\":\"50\",\"name\":\"Average CPU\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Perf | where Computer in~ ({Firewall}) | where CounterName == \\\"% Used Memory\\\" | summarize avg(CounterValue) by Computer\",\"size\":1,\"title\":\"Average Memory\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"linechart\"},\"customWidth\":\"50\",\"name\":\"Average Memory\",\"styleSettings\":{\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Bandwidth over time\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"\",\"size\":0,\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 0\"}]},\"name\":\"Bandwidth over time\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Perf | where Computer in~ ({Firewall})  | where (ObjectName == \\\"Load\\\") | summarize sum(CounterValue) by Computer, bin(TimeGenerated, 5m) \",\"size\":1,\"aggregation\":2,\"title\":\"Load over time\",\"timeContext\":{\"durationMs\":1800000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"Computer\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"sum_CounterValue\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"name\":\"Load over time\"}]},\"name\":\"Firewall Performance Details\"}],\"isLocked\":false,\"fallbackResourceIds\":[\"',variables('SourceID'),'\"]}')]",
       "version": "1.0",
        "sourceId": "[parameters('workbookSourceId')]",
        "category": "[parameters('workbookType')]"
      }
    }
	],
	"outputs": {
		"workbookId": {
			"type": "string",
			"value": "[resourceId( 'microsoft.insights/workbooks', parameters('workbookId'))]"
		}
	},
	  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#"
}